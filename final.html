<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini AI Client</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 950px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f5f5f5;
    }
    h1, h2 {
      text-align: center;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.95rem;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button.primary { background: #2563eb; color: white; }
    button.secondary { background: #e5e7eb; }
    button.danger { background: #dc2626; color: white; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hidden { display: none; }
    .status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .status.ok { color: #16a34a; }
    .status.error { color: #dc2626; }
    pre {
      background: #111827;
      color: #e5e7eb;
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
    }
    .endpoint-buttons {
      margin-bottom: 0.75rem;
    }
    .inline-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .inline-input input {
      flex: 1;
    }
    small {
      color: #6b7280;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h1>Mini AI Client</h1>

  <div id="connect-screen" class="card">
    <h2>Connect to Server</h2>
    <p>Enter the <strong>IP address</strong> or full URL of the FastAPI server.</p>
    <label for="server-input">Server IP or URL</label>
    <input
      type="text"
      id="server-input"
      placeholder="e.g. 127.0.0.1  or  http://127.0.0.1:8000"
    />
    <button id="connect-button" class="primary">Connect</button>
    <div id="connect-status" class="status"></div>
  </div>

  <div id="client-screen" class="card hidden">
    <h2>Connected</h2>
    <p>
      Connected to:
      <strong id="server-label"></strong>
    </p>

    <div class="card" style="background:#f9fafb;">
      <h3>Info & Health</h3>
      <div class="endpoint-buttons">
        <button id="btn-info"   class="secondary">GET /v1/info</button>
        <button id="btn-health" class="secondary">GET /v1/health</button>
        <button id="btn-chat-info" class="secondary">GET /v1/models/chat</button>
        <button id="btn-sent-info" class="secondary">GET /v1/models/sentiment</button>
      </div>
    </div>

    <div class="card" style="background:#f9fafb;">
      <h3>Chat with LLM (POST /v1/models/chat)</h3>
      <label for="prompt-chat">Chat prompt</label>
      <textarea id="prompt-chat" placeholder="Write something to the chat model..."></textarea>
      <button id="btn-chat" class="primary">Send chat</button>
      <small>Body: {"prompt": "your text"}</small>
    </div>

    <div class="card" style="background:#f9fafb;">
      <h3>Sentiment analysis (POST /v1/models/sentiment)</h3>
      <label for="prompt-sent">Text to analyse</label>
      <textarea id="prompt-sent" placeholder="Write text to analyse sentiment..."></textarea>
      <button id="btn-sent" class="primary">Analyse sentiment</button>
      <small>Body: {"prompt": "your text"}</small>
    </div>

    <div class="card" style="background:#f9fafb;">
      <h3>Chat Sessions (REST /chats ...)</h3>

      <h4>Create new chat (POST /chats)</h4>
      <label for="create-chat-msg">First user message</label>
      <textarea id="create-chat-msg" placeholder="Hi, let's start a conversation..."></textarea>
      <button id="btn-create-chat" class="primary">Create chat</button>

      <h4 style="margin-top:1rem;">Work with an existing chat</h4>
      <div class="inline-input">
        <input id="chat-id-current" type="text" placeholder="Chat ID" />
        <button id="btn-get-chat" class="secondary">GET /chats/{chat_id}</button>
      </div>

      <h4>Continue chat (POST /chats/{chat_id}/messages)</h4>
      <label for="continue-chat-msg">Next user message</label>
      <textarea id="continue-chat-msg" placeholder="Your next message in this chat..."></textarea>
      <button id="btn-continue-chat" class="primary">Send message</button>

      <h4>Edit latest user message (PUT /chats/{chat_id}/messages/latest)</h4>
      <label for="edit-latest-msg">New content for latest user message</label>
      <textarea id="edit-latest-msg" placeholder="New content for the latest user message..."></textarea>
      <button id="btn-edit-latest" class="secondary">Edit latest message</button>

      <h4>Edit specific user message by index (PUT /chats/{chat_id}/messages/{index})</h4>
      <div class="inline-input">
        <input id="edit-index" type="number" placeholder="Message index (0-based)" />
      </div>
      <label for="edit-message-msg">New content for that user message</label>
      <textarea id="edit-message-msg" placeholder="New content for the selected user message..."></textarea>
      <button id="btn-edit-message" class="secondary">Edit message by index</button>

      <h4>Delete chat (DELETE /chats/{chat_id})</h4>
      <button id="btn-delete-chat" class="danger">Delete chat</button>

      <small>
        The JSON response for all chat operations is the full ChatResource:
        {"id": "...", "messages": [{role, content}, ...]}.
      </small>
    </div>

    <h3>Result</h3>
    <pre id="result-box">// Responses will appear here</pre>
  </div>

  <script>
    let baseUrl = null;

    const connectScreen  = document.getElementById("connect-screen");
    const clientScreen   = document.getElementById("client-screen");
    const serverInput    = document.getElementById("server-input");
    const connectButton  = document.getElementById("connect-button");
    const connectStatus  = document.getElementById("connect-status");
    const serverLabel    = document.getElementById("server-label");
    const resultBox      = document.getElementById("result-box");

    const btnInfo       = document.getElementById("btn-info");
    const btnHealth     = document.getElementById("btn-health");
    const btnChatInfo   = document.getElementById("btn-chat-info");
    const btnSentInfo   = document.getElementById("btn-sent-info");

    const btnChat       = document.getElementById("btn-chat");
    const btnSent       = document.getElementById("btn-sent");
    const promptChat    = document.getElementById("prompt-chat");
    const promptSent    = document.getElementById("prompt-sent");

    const btnCreateChat    = document.getElementById("btn-create-chat");
    const btnGetChat       = document.getElementById("btn-get-chat");
    const btnContinueChat  = document.getElementById("btn-continue-chat");
    const btnEditLatest    = document.getElementById("btn-edit-latest");
    const btnEditMessage   = document.getElementById("btn-edit-message");
    const btnDeleteChat    = document.getElementById("btn-delete-chat");

    const createChatMsg    = document.getElementById("create-chat-msg");
    const continueChatMsg  = document.getElementById("continue-chat-msg");
    const editLatestMsg    = document.getElementById("edit-latest-msg");
    const editIndexInput   = document.getElementById("edit-index");
    const editMessageMsg   = document.getElementById("edit-message-msg");
    const chatIdCurrent    = document.getElementById("chat-id-current");

    function normaliseBaseUrl(raw) {
      raw = raw.trim();
      if (!raw) return null;

      if (raw.startsWith("http://") || raw.startsWith("https://")) {
        return raw.replace(/\/+$/, "");
      }
      return "http://" + raw + ":8000";
    }

    // Use /v1/health as connection test
    async function testConnection(url) {
      const resp = await fetch(url + "/v1/health");
      if (!resp.ok) {
        throw new Error("GET /v1/health failed with status " + resp.status);
      }
      return resp.json();
    }

    connectButton.addEventListener("click", async () => {
      connectStatus.textContent = "";
      connectStatus.className = "status";
      const raw = serverInput.value;
      const url = normaliseBaseUrl(raw);

      if (!url) {
        connectStatus.textContent = "Please enter a valid IP or URL.";
        connectStatus.classList.add("error");
        return;
      }

      connectButton.disabled = true;
      connectStatus.textContent = "Connecting...";
      try {
        const health = await testConnection(url);
        baseUrl = url;
        serverLabel.textContent = baseUrl;
        connectStatus.textContent = "Connected! /v1/health returned: " + JSON.stringify(health);
        connectStatus.classList.add("ok");

        connectScreen.classList.add("hidden");
        clientScreen.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        connectStatus.textContent = "Failed to connect: " + err.message;
        connectStatus.classList.add("error");
      } finally {
        connectButton.disabled = false;
      }
    });

    async function callEndpoint(path, options = {}) {
      if (!baseUrl) throw new Error("Not connected yet.");
      const resp = await fetch(baseUrl + path, options);
      const text = await resp.text();
      try {
        const parsed = JSON.parse(text);
        return JSON.stringify(parsed, null, 2);
      } catch {
        return text;
      }
    }

    // --- Info / health / model info ---
    btnInfo.addEventListener("click", async () => {
      resultBox.textContent = "Calling GET /v1/info ...";
      try {
        const res = await callEndpoint("/v1/info");
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    btnHealth.addEventListener("click", async () => {
      resultBox.textContent = "Calling GET /v1/health ...";
      try {
        const res = await callEndpoint("/v1/health");
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    btnChatInfo.addEventListener("click", async () => {
      resultBox.textContent = "Calling GET /v1/models/chat ...";
      try {
        const res = await callEndpoint("/v1/models/chat");
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    btnSentInfo.addEventListener("click", async () => {
      resultBox.textContent = "Calling GET /v1/models/sentiment ...";
      try {
        const res = await callEndpoint("/v1/models/sentiment");
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    btnChat.addEventListener("click", async () => {
      const prompt = promptChat.value.trim();
      if (!prompt) {
        resultBox.textContent = "Please enter a chat prompt.";
        return;
      }
      resultBox.textContent = "Calling POST /v1/models/chat ...";
      try {
        const res = await callEndpoint("/v1/models/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt })
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    btnSent.addEventListener("click", async () => {
      const prompt = promptSent.value.trim();
      if (!prompt) {
        resultBox.textContent = "Please enter text to analyse.";
        return;
      }
      resultBox.textContent = "Calling POST /v1/models/sentiment ...";
      try {
        const res = await callEndpoint("/v1/models/sentiment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: prompt })
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // POST /chats
    btnCreateChat.addEventListener("click", async () => {
      const firstMsg = createChatMsg.value.trim();
      if (!firstMsg) {
        resultBox.textContent = "Please enter the first user message.";
        return;
      }
      resultBox.textContent = "Calling POST /chats ...";
      try {
        const resText = await callEndpoint("/chats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: firstMsg })
        });
        resultBox.textContent = resText;

        try {
          const parsed = JSON.parse(resText);
          if (parsed.id) {
            chatIdCurrent.value = parsed.id;
          }
        } catch (_) { /* ignore parse errors */ }
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // GET /chats/{chat_id}
    btnGetChat.addEventListener("click", async () => {
      const chatId = chatIdCurrent.value.trim();
      if (!chatId) {
        resultBox.textContent = "Please enter a Chat ID.";
        return;
      }
      resultBox.textContent = `Calling GET /chats/${chatId} ...`;
      try {
        const res = await callEndpoint(`/chats/${encodeURIComponent(chatId)}`);
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // POST /chats/{chat_id}/messages
    btnContinueChat.addEventListener("click", async () => {
      const chatId = chatIdCurrent.value.trim();
      const msg = continueChatMsg.value.trim();
      if (!chatId) {
        resultBox.textContent = "Please enter a Chat ID (create a chat first).";
        return;
      }
      if (!msg) {
        resultBox.textContent = "Please enter a message to send.";
        return;
      }
      resultBox.textContent = `Calling POST /chats/${chatId}/messages ...`;
      try {
        const res = await callEndpoint(`/chats/${encodeURIComponent(chatId)}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // PUT /chats/{chat_id}/messages/latest
    btnEditLatest.addEventListener("click", async () => {
      const chatId = chatIdCurrent.value.trim();
      const newContent = editLatestMsg.value.trim();
      if (!chatId) {
        resultBox.textContent = "Please enter a Chat ID.";
        return;
      }
      if (!newContent) {
        resultBox.textContent = "Please enter new content for the latest message.";
        return;
      }
      resultBox.textContent = `Calling PUT /chats/${chatId}/messages/latest ...`;
      try {
        const res = await callEndpoint(`/chats/${encodeURIComponent(chatId)}/messages/latest`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: newContent })
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // PUT /chats/{chat_id}/messages/{index}
    btnEditMessage.addEventListener("click", async () => {
      const chatId = chatIdCurrent.value.trim();
      const indexStr = editIndexInput.value.trim();
      const newContent = editMessageMsg.value.trim();
      if (!chatId) {
        resultBox.textContent = "Please enter a Chat ID.";
        return;
      }
      if (!indexStr) {
        resultBox.textContent = "Please enter a message index.";
        return;
      }
      if (!newContent) {
        resultBox.textContent = "Please enter new content.";
        return;
      }
      const index = parseInt(indexStr, 10);
      if (Number.isNaN(index)) {
        resultBox.textContent = "Message index must be a number.";
        return;
      }
      resultBox.textContent = `Calling PUT /chats/${chatId}/messages/${index} ...`;
      try {
        const res = await callEndpoint(`/chats/${encodeURIComponent(chatId)}/messages/${index}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: newContent })
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });

    // DELETE /chats/{chat_id}
    btnDeleteChat.addEventListener("click", async () => {
      const chatId = chatIdCurrent.value.trim();
      if (!chatId) {
        resultBox.textContent = "Please enter a Chat ID.";
        return;
      }
      if (!confirm(`Are you sure you want to delete chat ${chatId}?`)) {
        return;
      }
      resultBox.textContent = `Calling DELETE /chats/${chatId} ...`;
      try {
        const res = await callEndpoint(`/chats/${encodeURIComponent(chatId)}`, {
          method: "DELETE"
        });
        resultBox.textContent = res;
      } catch (err) {
        resultBox.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
